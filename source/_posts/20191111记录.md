---
title: 20191111记录
date: 2019-11-11 10:43:00
tags:
- 记录
---

**本周**

- [x] 自定义特效转换工具
- [x] 资源检查工具改进
- [x] 摘出来检查特效的检查工具
- [ ] 新烘焙介绍

**打包工具**

- [ ] 老打包工具的bug，ignoreimage不正确
- [ ] 自动打包脚本co有中断的问题

**自动化**

- [ ] 例子测试系统弹窗的问题
- [ ] 不稳定例子
- [ ] 每日测试单元测试出错后报告不准确
- [ ] 每日测试单元测试出现网络验证失败
- [ ] 压缩截图（无损压缩）（继续找更高效的方式）
- [ ] 有SD leak，可以体现在log中，error：sound3D.lua
- [ ] 几个每日测试的WT
- [ ] sample测试老工具崩溃
- [ ] 把1和2改成old和new
- [x] 加屏蔽例子
- [ ] 14948的打印、1026的大量不一样、1017

**其他**

- [ ] 电脑蓝屏的问题
- [ ] 自定义特效转换脚本，转换自定义地表特效后续与胖哥讨论
- [ ] 自定义特效的转换，转换后法线消失。
- [ ] ambient的复制问题
- [ ] 整理打包工具检查alpha通道的代码
- [ ] 旧的导出功能问题（导出特效编辑器）
- [ ] 几个编辑器拷贝postlua的删除
- [ ] 写周报

# 资源检查工具任务安排

## 模型相关

1. PVS合并 拆开之后所有的都是子模型 关注的是 每一个子模型的数据
2. PVS合并，之前的逻辑，node一样的话才能合并。 每一个node里的模型的数据

**1. mesh（用PVS可以忽略这项数据）**

msh文件不超过50KB，把D、P、顶点的长度
(vertexBuffer)、数量，索引的长度(indexBuffer)和数量给出来

**2. submesh（用PVS合并的检查此项数据）**

模型(子模型) ： 顶点的长度
(vertexBuffer)、数量，索引的长度(indexBuffer)和数量

**3. skn**

skn文件不超过75KB  skn 不用拆子模型，因为它不参与合并
D、P、Format、(vertexBuffer)、数量，索引的长度(indexBuffer)和数量

**4. 其他**

标准：skn模型的D值不超过2；msh模型的D值不超过3，注释掉这个检查

## 其他

1. skl文件的骨骼数量改动为66

   shader数组定义最多有256个，其中除去光等的占用，剩余每个骨骼占用3个（开启GpuSkinning），最多66个

2. 屏蔽掉 标准：图片格式应为BMP-24或TGA-32 这个检查

3. pfx自定义特效的打印有连续空行空行

4. 资源合规检查中缺失资源中的烘焙文件的检查 根据scene_rd_setting来看是bake 还是lightmass

# 1111

创建分支

## 特效转换成普通特效，带法线的不转换

补全单元测试

第一版提交到分支，后期修改

接下来重构分成单个的子模块

拆成：

1. 处理自定义代码得到基本参数子模块；
2. 转换自定义为普通特效子模块；
3. 转换缩减自定义代码子模块。

## 缩减特效自定义代码

问题记录：

- 删除代码

1. 特效用编辑器打开，没有显示各个参数（保存之后有老代码？可能没有保存下来新的代码）
2. 版本11935删除了

```lua
for i, man in ipairs(pi.userMesh:getAnimas()) do
    if man.loop or pi.tick <= man.duration then
        man.current = pi.tick
    end
end
if pi.userMesh.skeleton then
    for i, san in ipairs(pi.userMesh.skeleton:getAnimas()) do
        if san.loop or pi.tick <= san.duration then
            san.current = pi.tick
        end
    end
end
```

在自定义代码中，把这里加回来，对比加载老特效的时候报错

- 在特效制作之后编辑器添加代码

# 1112

自定义特效转换工具

**提取自定义代码**

测试：28/840

区分新老特效：17/28

重新调用save保存：7/17

增加了tick代码4/7

需要重新保存并制作的特效1/3

```
'kog_zy_new_boss_yemu_jixie_skill05_paodan.pfx',
'kog_zy_cha_nan_td_1_skill03_01_p_03_02.pfx',
```

原因

enumMesh设置material

总体测试结果

```lua
-- 添加代码tick,实际没有影响
'kog_zlq_mon_xueshou_002_skill01_01.pfx',
'kog_zlq_nv_dun_skill04_02f_01.pfx',
'kog_zlq_pet_jn_02.pfx',
'pfx_mon_xueshou_002_skill03.pfx',
-- 区别不大
'kog_zy_mon_xinshouboss_001_skill03_02_03.pfx',

-- 新的报错少skl,skn，图片一样,调用pfx的save方法保存后没有问题了
'kog_zlq_huan_lp02_skill01_cheng_01.pfx',
'kog_zlq_huan_lp02_skill01_hong_01.pfx',
'kog_zlq_huan_lp03_skill01_cheng_01',
'kog_zlq_huan_lp03_skill01_hong_01',
'kog_zlq_mon_gongchengji_001_die.pfx',
'kog_zlq_mon_jjxg_die_01.pfx',
'kog_zlq_npc_nvjunguan_001_skill01_01.pfx',
'low_kog_zlq_huan_lp02_skill01_cheng_01.pfx',
'low_kog_zlq_huan_lp02_skill01_hong_01.pfx',
'pfx_pet_ioc_007_emo.pfx',

-- 图片区别大,添加代码enumMesh导致，需要用编辑器重新保存后看效果再修改
'kog_zy_new_boss_yemu_jixie_skill05_paodan.pfx',
'kog_zy_cha_nan_td_1_skill03_01_p_03_02.pfx',
```



# 1113

- [x] review分支自定义特效转换的代码
- [ ] 测试转换成普通模型的工具
- [ ] 调整带法线的忽略代码
- [ ] 资源检查工具特效加地表
- [x] 整理资源检查工具的方案，继续资源检查工具

## 自定义特效转换工具

问题记录：

1. Resource_Toolkit的单元测试有两个`do return end`
2. 使用自动测试资源工具对比转成普通模型特效后的效果
3. 带法线的自定义模型不转换代码需要调整

## 资源检查工具

1. 取消普通模型msh的D值检查

   已提交在主干

2. 烘焙资源检查

   提交在分支，尚未合并到主干

### 模型相关改进

msh

1. size

   size， msh name

2. P/D

   P， D， P/D，mesh name

3. vertexBuffer等

   多标准，mesh name

subMesh

## 资源检查工具

**烘焙贴图缺失资源检查**

整理代码（先提交），补充和检查单元测试（先注释提交，或引擎分支合并到主干后出fs引擎再提交）

**检查模型相关**

整理接下来的模型检查设计和修改方案

To do List

- [ ] 拆分msh和skn的检查
- [ ] 导出接口
- [ ] 

问题记录：

是否需要加宏

## 其他



优化内存

优化性能

# 1114

- [x] 提交资源检查工具相关代码
- [x] 自定义特效忽略比例测试
- [ ] 写新烘焙小作文
- [x] 自动化测试结果处理
- [x] 单独检查特效的工具

## 检查文件夹特效工具

1. 检查一个文件夹下的所有特效资源
2. 检查目标路径下多个文件夹的资源，调用检查一个的接口

**检查项**

文件检查项

1. 不应有缺失文件
2. 不同路径下的文件也不要重名

特效检查项

# 1115

- [x] 昨天打包特效报错的问题
- [x] 导出新的资源检查工具和自定义特效转换工具
- [x] 给飞哥的特效检查工具
- [x] 看昨天的自动化测试结果
- [ ] 自定义特效转换工具打包使用的说明和提交

验证：

Jenkins断掉后，已启动的exe运行内容是否结束

# 1116

- [x] needed出个包
- [ ] 验证没有问题
- [x] 记录WT如何使用自定义特效转换工具(标注注意事项)
- [ ] 小作文

## 自定义特效工具使用说明

**获取工具**

可以通过以下两种方式获取工具：

1. 从fancy-module导出`Tool_ConvertUserDefinedPfx`模块

   导出该模块后，需要添加**引擎、modulecommon.lua、code.lua**

   其中code.lua：

   ```lua
   _dofile('modulecommon.lua')
   local cvtpfx = _require('Tool_ConvertUserDefinedPfx')
   
   local respath = [[D:\tmp]]
   cvtpfx:convertPfxToNormal(respath) -- 转换成普通特效用这个
   -- cvtpfx:convertPfxReduceCode(respath) -- 缩短自定义代码用这个
   
   _abort()
   ```

2. 16.15地址：

   `\\10.1.16.15\temp\liujuanjuan\tmp\自定义特效转换工具\Tool-ConvertUserDefinedPfx.zip`

### 一、自定义特效转换成普通特效

- 目标对象：项目美术和程序

- 功能：将部分自定义特效转换为普通特效，提升性能

- 工具：code.lua使用的接口为**convertPfxToNormal**

- 使用：

  - code.lua中修改需要转换特效的路径
  - 点击exe
  - 查看转换特效

- 注意事项

  工具会修改指定路径下的资源，如需保存原资源，请在转换前备份

### 二、自定义特效转换自定义代码

- 目标对象：QA

- 功能：缩短特效保存的信息，降低内存开销

- 工具：code.lua使用的接口为**convertPfxReduceCode**

- 使用：

  1. 转换特效
     - code.lua中修改特效所在路径
     - 点击exe
  2. 项目代码处理
     - 在code文件夹下加userdefined.lua（路径：`Tool_ConvertUserDefinedPfx\ConvertEmitter_ReduceUDCode\code\userdefined.lua`）
     - 在code/list.lua中加_dofile('userdefined.lua')
  3. 打包工具处理
     - code文件夹下加userdefined.lua
     - 在code/build.lua中加_dofile('userdefined.lua')
     - 将userdefined.lua加到**needed分组**

- 注意事项：

  1. 检查打包工具是否添加了userdefined.lua（否则打包过程会发生崩溃）

  2. 将userdefined.lua加到needed分组（手包加载自定义特效报错）

  3. 转换之后**无法使用编辑器编辑**



问题记录：

对于已经转换过的特效检查后不再转换

检查pfx

![1573890051641](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1573890051641.png)



