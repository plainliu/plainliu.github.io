---
title: 20200113记录
date: 2020-01-13 10:45:17
tags:
typora-copy-images-to: image
---



# 0113

## WP工具自动化集成

### 总流程

![1578886179366](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1578886179366.png)

1. 开发环境开发

   - 分别在各自的分支开发
   - 开发分支上**单元测试**通过

   - 联调，以例子验证功能完整并通过

2. 合并到主干触发自动化测试

   - 自动进行单元测试，不通过则通知开发人员并回到开发阶段解决；

   - 通过则build并进行**集成测试**，期间build和IT有不通过，回到开发阶段解决；
   - （IT通过后进入QA阶段，以项目资源进行测试，通过后记录）

   - IT通过后记录两边的通过版本/tag（记录表），以便查找并部署到正式环境

3. 部署到正式环境

   从集成测试通过的记录表中查找成功的记录并部署

### 部署过程

![1578895500272](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1578895500272.png)

部署期间保持版本匹配，对用户进行暂时关闭

- WP修改版本
- F3D修改版本/配置



### 实践

1. 触发（job轮询）
2. 对应触发svn/git的单元测试
3. 集成测试（继承测试的版本应该和记录的通过版本一致）



### 讨论

与阿杜讨论

1. 单元测试

   逻辑接口可以做

   显示不可以做

2. 集成测试

   入库的问题



之后

F3D：



##  自动化集成具体任务

### 一、触发测试

提交到主干自动触发自动化集成的测试过程

- 实现

  Jenkins

- 触发内容
  1. F3D的svn提交触发
  2. WP的git提交触发

- 触发机制
  1. 轮询机制
  2. 提交触发（钩子）

### 二、单元测试

**F3D**

- 获取模块资源

  checksvn

- 单元测试

  所有模块的单元测试

- build（导出工具）

  如果工具没有发生改变，则不继续测试

- **job的相关测试？**

  job使用的代码应该受版本控制

**WP**

- 获取资源

  git clone/pull

- 单元测试

  逻辑部分/显示部分

  job调用单元测试命令

- build

### 三、集成测试

当前WP“一键评估/打包”的扩展

- job调用集成测试

  这里需要类似原按钮的api调用

- 集成测试的脚本存储和测试内容的维护

- 编写集成测试的脚本和资源（大部分需要WP做）

### 四、通过的记录表

- 存储位置

- 存储表信息格式

  对于上线版本的处理，根据module分支选择对应的记录表

- 维护方式



TODO：

首先把框架搭起来，串起来线，再一步步填充



## 其他

- [x] 自动化单元测试的引擎换成最新的不带验证的引擎
- [x] 尝试远程连接启动渲染窗口



# 0114

## 持续集成

参考<https://stackoverflow.com/questions/10014252/jenkins-ci-how-to-trigger-builds-on-svn-commit>



job设置轮询

1. 使用svn版本控制
   - 绝对路径测试部通过
2. 使用poll SCM轮询
   - 设置轮询间隔



单元测试，判断是否通过

1. 运行相关单元测试
2. 看是否通过
3. 



模块本身的集成

只要提交，触发，测试所有，发送结果到群



模块的提交触发更大的集成功能

如果通过，看相关功能的代码是否有改动；

如果有改动，触发集成测试



过程：

1. 触发启动

   git/svn

   先拿资源

2. 根据触发的原因做单元测试

3. 集成测试

## 远程跑任务

创建定时任务

![1578990096140](C:\ljj\git\worknotes\source\_posts\image\1578990096140.png)



![1578990190468](C:\ljj\git\worknotes\source\_posts\image\1578990190468.png)

设置为开机启动，

选择操作：启动程序

填写启动的脚本为需要启动的bat

![1578990648714](C:\ljj\git\worknotes\source\_posts\image\1578990648714.png)

选择下面的复选框

打开任务属性对话框

![1578990858105](C:\ljj\git\worknotes\source\_posts\image\1578990858105.png)

点击确定，出现下面的界面，勾选上面的“不存储密码”，则不出现下面的弹窗

![1578990944847](C:\ljj\git\worknotes\source\_posts\image\1578990944847.png)



上面的方式没成功



将快捷方式放到

`C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup`

在登录时启动



换成

`C:\Users\Default\AppData\Roaming\Microsoft\Windows\Start Menu\Programs`

不好使



开机用计划任务的方式自动拉起fancy-dev，有主循环的例子进入不到主循环，用-tool模式没问题，启动后没有窗口显示

# 0115

15秒启动新bat

## 修改模型检查标准

WP

## 云主机机器人

开机自启动测试

## 自动化测试

```lua
_System.getUsedMemory = function(self, immediate)
    return 0
end
```

## 自动化集成

1. 触发

   svn +  git 两个库同时作为轮询对象

   co svn的地址能否为绝对地址

2. 由能够两个库触发决定是否拆开UT

3. UT部分

   - 真实的UT（bat启动）
   - 将UT结果变成grovy文件
   - 由是否通过决定下一步的操作

4. 在git库中增加一个“发送消息”



### groovy

全局变量引用

env.xxx 环境变量

params.xxx 定义参数

currentBuild.xxx 当前pipeline的信息

```
Jenkinsfile (Scripted Pipeline)
node {
    checkout scm 
    /* .. snip .. */
}
```

该`checkout`步骤将检出从源控制代码; `scm`是一个特殊变量，指示`checkout`步骤克隆触发此Pipeline运行的特定修订。

假设一个名为“Greeting”的String参数已经在配置中 Jenkinsfile，它可以通过${params.Greeting}以下方式访问该参数



声明性Pipeline默认支持robust失败处理经由其[post section](https://jenkins.io/doc/book/pipeline/syntax/#post)，其允许声明许多不同的“post conditions”，例如：always，unstable，success，failure，和 changed。“ Pipeline[语法”](https://jenkins.io/doc/book/pipeline/jenkinsfile/#syntax)部分提供了有关如何使用各种帖子条件的更多详细信息。

```
    post {
        always {
            junit '**/target/*.xml'
        }
        failure {
            mail to: team@example.com, subject: 'The Pipeline failed :('
        }
    }
```

##### post条件

- `always`

  运行，无论Pipeline运行的完成状态如何。

- `changed`

  只有当前Pipeline运行的状态与先前完成的Pipeline的状态不同时，才能运行。

- `failure`

  仅当当前Pipeline处于“失败”状态时才运行，通常在Web UI中用红色指示表示。

- `success`

  仅当当前Pipeline具有“成功”状态时才运行，通常在具有蓝色或绿色指示的Web UI中表示。

- `unstable`

  只有当前Pipeline具有“不稳定”状态，通常由测试失败，代码违例等引起，才能运行。通常在具有黄色指示的Web UI中表示。

- `aborted`

  只有当前Pipeline处于“中止”状态时，才会运行，通常是由于Pipeline被手动中止。通常在具有灰色指示的Web UI中表示。

#### 可用选项

- buildDiscarder

  持久化工件和控制台输出，用于最近Pipeline运行的具体数量。例如：`options { buildDiscarder(logRotator(numToKeepStr: '1')) }`

- disableConcurrentBuilds

  不允许并行执行Pipeline。可用于防止同时访问共享资源等。例如：`options { disableConcurrentBuilds() }`

- skipDefaultCheckout

  在`agent`指令中默认跳过来自源代码控制的代码。例如：`options { skipDefaultCheckout() }`

- skipStagesAfterUnstable

  一旦构建状态进入了“不稳定”状态，就跳过阶段。例如：`options { skipStagesAfterUnstable() }`

- timeout

  设置Pipeline运行的超时时间，之后Jenkins应该中止Pipeline。例如：`options { timeout(time: 1, unit: 'HOURS') }`

- 重试

  失败后，重试整个Pipeline指定的次数。例如：`options { retry(3) }`

- timestamps

  预处理由Pipeline生成的所有控制台输出运行时间与发射线的时间。例如：`options { timestamps() }`

```
Jenkinsfile (Declarative Pipeline)
pipeline {
    agent any
    options {
        timeout(time: 1, unit: 'HOURS') 
    }
    stages {
        stage('Example') {
            steps {
                echo 'Hello World'
            }
        }
    }
}
```

##### 可用参数

- 串

  字符串类型的参数，例如： `parameters { string(name: 'DEPLOY_ENV', defaultValue: 'staging', description: '') }`

- booleanParam

  一个布尔参数，例如： `parameters { booleanParam(name: 'DEBUG_BUILD', defaultValue: true, description: '') }`

```
Jenkinsfile (Declarative Pipeline)
pipeline {
    agent any
    parameters {
        string(name: 'PERSON', defaultValue: 'Mr Jenkins', description: 'Who should I say hello to?')
    }
    stages {
        stage('Example') {
            steps {
                echo "Hello ${params.PERSON}"
            }
        }
    }
}
```

#### 触发器

该triggers指令定义了Pipeline应重新触发的自动化方式。对于与源代码集成的Pipeline，如GitHub或BitBucket，triggers可能不需要基于webhook的集成可能已经存在。目前只有两个可用的触发器是cron和pollSCM。

- cron

  接受一个cron风格的字符串来定义Pipeline应重新触发的常规间隔，例如： `triggers { cron('H 4/* 0 0 1-5') }`

- pollSCM

  接受一个cron风格的字符串来定义Jenkins应该检查新的源更改的常规间隔。如果存在新的更改，则Pipeline将被重新触发。例如：`triggers { pollSCM('H 4/* 0 0 1-5') }`

#### 内置条件

- branch

  当正在构建的分支与给出的分支模式匹配时执行阶段，例如：`when { branch 'master' }`。请注意，这仅适用于多分支Pipeline。

- environment

  当指定的环境变量设置为给定值时执行阶段，例如： `when { environment name: 'DEPLOY_TO', value: 'production' }`

- expression

  当指定的Groovy表达式求值为true时执行阶段，例如： `when { expression { return params.DEBUG_BUILD } }`

- not

  当嵌套条件为false时执行阶段。必须包含一个条件。例如：`when { not { branch 'master' } }`

- allOf

  当所有嵌套条件都为真时，执行舞台。必须至少包含一个条件。例如：`when { allOf { branch 'master'; environment name: 'DEPLOY_TO', value: 'production' } }`

- anyOf

  当至少一个嵌套条件为真时执行舞台。必须至少包含一个条件。例如：`when { anyOf { branch 'master'; branch 'staging' } }`

```
Jenkinsfile (Declarative Pipeline)
pipeline {
    agent any
    stages {
        stage('Example Build') {
            steps {
                echo 'Hello World'
            }
        }
        stage('Example Deploy') {
            when {
                branch 'production'
                anyOf {
                    environment name: 'DEPLOY_TO', value: 'production'
                    environment name: 'DEPLOY_TO', value: 'staging'
                }
            }
            steps {
                echo 'Deploying'
            }
        }
    }
}
```

# 0116

## 自动化测试例子

修改例子

15719-lua内存分配统计

## 云主机

**计划任务**

镜像部署测试

引擎替换

**启动多次**

间隔30-60s，设置成45秒

**部署说明**

1. 过程
2. 注意事项

## 自动化测试例子工具

1. 拷贝dll
2. debug版的问题，修改成绝对路径
3. fancy-sample的地址寻找
4. 拷贝lic位置
5. 保留单元测试结果

## 自动化集成

把模块检查功能提取到库中

模块检查又分为

- 格式检查
- 单元测试

模块检查调用如上两个方法



语法

<https://jenkins.io/doc/book/pipeline/syntax/>



# 0117

## 云主机机器人

服务器号被封了，等解决

提取镜像部署过程

1. 选一台部署机器，将替换的运行内容部署好

2. 点击关机

3. ...中选择其他，提取镜像

4. 在镜像的页面中，一键部署多台机器

   注意：http连接，DHCP自动分配IP地址，如果是静态的，则需要手动分配IP地址

5. 等待，结束

后续过程

1. 手动修改一台机器上的内容
2. 通过jenkins调用云主机的api进行一键部署，完成提取镜像、复制镜像、启动机器的操作
3. （启动机器即开始跑流程），停止即批量关机

## 自动化测试例子工具

修改

优化

## 自动化集成

构造测试资源（通过和不通过的版本）

补充Jenkinsfile

测试流程



tips

1. 单元测试定时器需要在启动单个单元测试时加进来
2. Package_Toolkit下文件位置错误



# 0119

## 集成

1. 触发机制
2. 发消息

调用子job的代码需要指定子job node

## 云主机

需要替换引擎

自动化部署

## 单元测试结果

打包模块不通过

资源检查模块不通过

