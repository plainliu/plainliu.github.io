---
title: 20191104记录
date: 2019-11-04 10:43:00
tags:
- 记录
---

> 万恶的蓝屏，本周的记录清空了，周四回忆式记录，愤怒而淡定重写，决定每天push到github仓库

**本周**

- [x] reportUsage音频内存信息打印
- [ ] 资源检查工具改进
- [ ] 修改项目打包job

**打包工具**

- [ ] 老打包工具的bug，ignoreimage不正确
- [ ] 自动打包脚本co有中断的问题

**自动化**

- [ ] 例子测试系统弹窗的问题
- [ ] 不稳定例子
- [ ] 每日测试单元测试出错后报告不准确
- [ ] 每日测试单元测试出现网络验证失败
- [ ] 压缩截图（无损压缩）（继续找更高效的方式）
- [ ] 有SD leak，可以体现在log中，error：sound3D.lua
- [ ] 几个每日测试的WT
- [ ] sample测试老工具崩溃
- [ ] 把1和2改成old和new
- [x] 加屏蔽例子
- [ ] 14948的打印、1026的大量不一样、1017

**其他**

- [ ] 电脑蓝屏的问题
- [ ] 自定义特效转换脚本，转换自定义地表特效后续与胖哥讨论
- [ ] 自定义特效的转换，转换后法线消失。
- [ ] ambient的复制问题
- [ ] 整理打包工具检查alpha通道的代码
- [ ] 旧的导出功能问题（导出特效编辑器）
- [ ] 几个编辑器拷贝postlua的删除
- [ ] 写周报

# 1104

## 添加reportUsage音频打印

_FANCY_DEVELOP_VERSION宏

统计播放过程中的音频占用内存

fmod声音引擎文档查找

为true打印每个声音的尺寸

##  资源检查工具任务安排

### 模型相关

1. PVS合并 拆开之后所有的都是子模型 关注的是 每一个子模型的数据
2. PVS合并，之前的逻辑，node一样的话才能合并。 每一个node里的模型的数据

**1. mesh（用PVS可以忽略这项数据）**

msh文件不超过50KB，把D、P、顶点的长度
(vertexBuffer)、数量，索引的长度(indexBuffer)和数量给出来

**2. submesh（用PVS合并的检查此项数据）**

模型(子模型) ： 顶点的长度
(vertexBuffer)、数量，索引的长度(indexBuffer)和数量

**3. skn**

skn文件不超过75KB  skn 不用拆子模型，因为它不参与合并
D、P、Format、(vertexBuffer)、数量，索引的长度(indexBuffer)和数量

**4. 其他**

标准：skn模型的D值不超过2；msh模型的D值不超过3，注释掉这个检查

### 其他

1. skl文件的骨骼数量改动为66

   shader数组定义最多有256个，其中除去光等的占用，剩余每个骨骼占用3个（开启GpuSkinning），最多66个

2. 屏蔽掉 标准：图片格式应为BMP-24或TGA-32 这个检查

3. pfx自定义特效的打印有连续空行空行

4. 资源合规检查中缺失资源中的烘焙文件的检查 根据scene_rd_setting来看是bake 还是lightmass

# 1105

## 资源检查工具

记录

## ASTC分支的检查

update到最新就没问题了

## 项目打包job修改讨论

记录

# 1106

## 资源检查工具

记录

# 1107

## 资源检查工具

提交烘焙相关的资源缺失检查

修改引擎接口和提交模块化内容

记录

烘焙：分支引擎崩溃

### 模型相关改进

取消普通模型msh的D值检查

## 项目出版job第二版

给项目分支地址和module地址

## 修改自定义特效转换工具

带法线的自定义模型特效不转换

## 其他

重写本周记录，新建github仓库，push

今天的测试结果

# 1108

## 资源检查工具

**烘焙贴图缺失资源检查**

整理代码（先提交），补充和检查单元测试（先注释提交，或引擎分支合并到主干后出fs引擎再提交）

**检查模型相关**

整理接下来的模型检查设计和修改方案

## 转换自定义特效的脚本

修改并提交

- 问题：
- 代码逻辑不清晰

## *缩减自定义特效代码长度

看编辑器实现

提取代码

写转换脚本和给项目的代码

**方案**

- 写例子，把特效转换和拆分，保证效果不变

  转换模型

  - 取老的信息，拼接新的代码信息
  - 具体的代码过程写到文件中
  - 以测试资源为例，开始拆分

- 针对不同的自定义类型区分处理方式

**转换流程**

1. 解析

   使用编辑器的解析方式解析原本的代码

   拿到参数后给自定义特效分类，以确认生成什么样的新代码

2. 缩减代码

   生成新的自定义代码

   - 定义`local resMesh = '...'`

   - 传参

     set方法设置，在脚本代码中赋值和操作

   - 设置回调函数

3. 保存特效

4. 运行

   把各个执行函数提取到单独的脚本中

   以期在新的自定义代码中调用这些方法

**最终的效果**

```Lua
local version = 1
local pfxEmitter = _loadingRes

-- Terrain/Mesh/Light Params
local resMesh = ''
...
pfxEmitter:setMeshParams(resMesh, ...)

-- Dissolve Params
local dissolve = true
...
pfxEmitter:setDissolveParams()

-- Set Callback
pfxEmitter:onCreate(_ParticleEmitter.onCreateMeshFunc)
pfxEmitter:onDestroy(_ParticleEmitter.onDestroyMeshFunc)
pfxEmitter:onRender(_ParticleEmitter.onRenderFunc)
```

**使用**

先缩减自定义代码，如果优化可观，则可不用转换成普通特效了

以上第一版

讨论后第二版

**方案二**

在打包的时候去做的处理

这样不必考虑后期开发的可读性

用索引和值生成表，之后传入函数，dostring这个字符串

尽量缩减字符串长度

## 自动化测试

查看昨天和今天测试的结果

处理16上的无效结果

- 屏蔽两个异步加载的例子
- 删除近几天无效的结果

# 1109

## 缩减自定义特效代码长度

**方案二**

目的：尽最大程度缩减代码长度

在打包前做一次处理，然后对应的脚本

**最终效果**

```lua
local pe = _loadingRes
pe:udFunc({[1] = 'xxx', [2] = 'xxx', [3] = ...}) -- 加[]比较长，且达到10后占两个字符，可再去掉空格，去掉小括号
pe:udFunc({a = 'xxx', b = 'xxx', c = ...})
```

进一步缩减

```lua
-- 保存内容
_loadingRes:udFunc{a='xxx',b='xxx',c=...}
```

对于ud函数，传入的参数是一个表

函数中再做对应的处理，重写onCreate等函数

**实现**

- 列举所有参数，并定义参数保存在自定义代码中的key
- 转换特效，替换自定义代码
- 解析新代码（需要预加载的脚本）

**调整**

两种自定义特效的转换（转成普通特效/缩减自定义代码长度）放在一个模块下



**测试**

用自动化测试资源的工具

用同一版引擎，测试转换前后两个文件夹的特效进行对比

注意：

- 修改resource检查入口文件
- 需要dofile新脚本
- 检查中间删除文件夹的操作，不要误删第一次检查的结果
- 特效加terrain

**问题记录**

- 需要有个标记来记录是哪一种特效
- dissolvesize保留小数4位
- pi.dissolve是什么参数，从哪里拿到的

## 自动化测试

当天问题：

昨天添加了屏蔽的例子，今天继续出现了

原因：

测试机10.1.16.131上没有更新的权限，可能有几天没更新了

处理：

先登录我的账号，查看当前module和sample资源的版本号

看是否再次测试

首先代码检查和模块单元测试需要再次测试，因为本身检查的是模块内容

sample不用测试，每天的引擎出版正常，影响只是例子没更新

结论：

看版本sample在最新，module只差昨天晚上屏蔽的提交，对测试没有影响，均无需重新测试

# 1110

## 缩减特效自定义代码

问题记录：

1. 特效用编辑器打开，没有显示各个参数（保存之后有老代码？可能没有保存下来新的代码）
2. 版本11935删除了

```lua
for i, man in ipairs(pi.userMesh:getAnimas()) do
    if man.loop or pi.tick <= man.duration then
        man.current = pi.tick
    end
end
if pi.userMesh.skeleton then
    for i, san in ipairs(pi.userMesh.skeleton:getAnimas()) do
        if san.loop or pi.tick <= san.duration then
            san.current = pi.tick
        end
    end
end
```

在自定义代码中，把这里加回来，对比加载老特效的时候报错







# 其他记录

- [ ] 资源检查工具的config不太好，子模块于大模块不独立，config去设置子模块参数而不是定义子模块参数


## 记录Nsight使用



待办：

看保险配置

闲置、双11

备注：

anaconda

