---
title: 20191216记录
date: 2019-12-16 10:42:10
tags:
---

- [ ] 自动化测试

  - 去掉验证和签名的patch，在引擎中加宏控制

- [x] 检查特效job整理

  - 区分项目名称
  - 当前开发环境不能连通（使用中间数据）
  - 测试环境使用小例子（提交测试资源到svn）【因为给WP控制资源的版本，项目资源太大，也使用中间数据】

- [ ] 检查特效和WP对接

  - 增加资源传参字段（执行的链接中需要加指定资源版本的svn地址、svn版本；和打包资源使用同一个svn地址）

  - 完善对传递参数的判断和出错报告（之后有问题再加错误上报）

- [ ] 检查特效和飞哥对接

  - 加meshP检查的时机

  - 加texture字段的优先级
  - 特效是否使用除pfx文件夹外的资源

- [ ] 检查特效和项目使用对接

  - 现在使用的机器检查时间长（硬盘、和打包在一起进行）
  - 确认测试环境不锁屏，能够测试资源

- [ ] 检查特效代码整理

  - command中的配置区分项目

  - 使用的引擎需要自动化测试使用的（暂时提交到分支一版引擎，未定后续方案）
  - 单元测试
  - 拆分当前代码

- [ ] 检查特效性能优化

  - 添加时间统计

  - 加速检查时间

- [ ] 其他

  修改统计D值统计

- [ ] 



# 1216

- [x] 验证 WP ID 为空

  如果为最后一个参数，闪退

  如果是中间的参数，拿到的为空字符串

- [x] 修改job名

- [x] 正式环境的job修改

- [ ] 平时提交不带验证的fob到libs

  问题：原本用来开发阶段使用的内容，参与到项目实际运用中有风险；另外开发过程中可能提交带验证的引擎

  建议：提交另一个目录，类似于copylibs的操作，使用该目录下不带验证的引擎进行

- [ ] lua中处理 

  wpid的判断，拿到空就退出

- [ ] 



**单个检查时间长**

1. 配置区别？系统区别？磁盘区别？运行时其他进程抢占？
2. 

**增量检查特效**

1. 特效使用的资源变化，特效本身没有变化（隐患）
2. 方案：检查依赖的资源，依赖资源的数量和MD5没变化，则不需要重新测试
3. 增量意味着保留了中间数据，有缓存（不能clean）



# 1217

**功能**

与WP连接，需要增加进度信息



**讨论和WP对接配置**

1. 测试机安排
2. 分支安排

## 和WP连接的工具

TODO：

1. 取消验证的引擎放在16.15，job从16拷贝引擎
2. 把分支内容合并到主干
3. 测试环境使用的module为主干
4. 从主干打分支出来作为给WP的正式环境
5. 将测试环境从本机移动到19
6. 取消验证的引擎放在16.15



**合并主干前**

1. 修改引擎从16复制
2. 添加时间统计
3. 调整生成json和发送json的顺序
4. 把临时文件pfx.lua换个位置
5. 检查格式

**合并主干需要注意**

1. 提交的引擎不需要合并
2. 例子资源不需要合并
3. 临时文件pfx.lua提交到其他位置

**改变测试环境使用的job**

1. 测试环境使用module主干
2. 测试环境移动到19
3. 测试修改内容【改变测试资源，删除测试资源】

**修改正式环境使用的内容**

1. 从主干打分支出来作为给WP的正式环境
2. 确定正式环境使用的机器【暂时布置到131上，之后到193】



**功能方面**

增加进度信息



统计特效单个模型的P值

- 单个模型
- 单个子模型

统计单个模型的

**去掉meshP的播放统计**



其他：

增加一个addPaths的方法，工具使用



# 1218

## 检查特效新功能

- 进度信息

  1. 先遍历一次，拿到列表

  2. 将获取资源信息的过程分为95%

     （列表特效数量均分95）

     另外5%解析数据

  3. 写发送信息的功能

     传入进度数据和信息

     发送给WP信息

  4. 

- 单个模型最大P

  1. 去掉子进程中播放模型的过程
  2. 将返回meshP的值替换为返回单个模型最大P
  3. 

## 其他

- 整理环境搭建笔记-218-云爷

  job

  java环境

  python环境

  pip install

- 处理单元测试问题



发送给WP的信息中有中文：

现象

1. 使用python命令行参数传参，失败
2. 将`_sys.command`换成`_sys.doCommand`后可以发送
3. 词尾仍然有乱码，将bat内容`\n`换成`\r\n`还是有问题
4. 在命令行末尾删除多余信息，部分失败
5. 将lua文件重新保存为gbk编码，在bat中显示的内容和换格式后的乱码一致（推论：cmd处理方式为gbk）

背景：

1. lua为utf-8
2. python为utf-8
3. cmd命令行：chcp：936

推论：

1. cmd命令处理方式为gbk
2. 将lua文件转换为gbk编码解决

尝试：

1. 用doCommand
2. 将中文改成英文没有问题

# 1219

- 近期的安装整理-218-云爷

- 把昨天晚上检查特效的结果发给啊杜，之后

    1. 把带进度信息的内容放到正式环境，和WP测试正式环境

    2. 把lua表转换为py格式

       判断是数组

       转换字符串

    3. 修改检查特效中用到的字符串拼接

       - 将字符串保存为py的方法
   - 
   
    4. 

# 1220

- 增加工具基础配件模块
- 增加addPaths方法
- 增加发送信息给WP的功能方法
- 整理代码结构
  - 拆分获取数据模块和分析数据模块
- 安排
  - 删除假数据处理的功能
  - 将生成配置和分析阶梯数据提取成模块
  - 表格信息完善
- 



## 生成配置和分析阶梯数据提取成模块

功能：生成配置和分析阶梯数据

原始数据 --> 分析数据信息 --> 合成发送数据

### 对于每一项特定的检查

**输入**

- 原始数据

  含每个检查对象的详细信息

- 检查对象

  在详细信息中读取检查内容所用到的key

- 配置列表，数组、每一项：

  - min
  - max
  - 标准比例

**输出**

对于不同的检查工具，通用的需要返回的内容是

- 标准比例
- 实际比例
- 是否通过（默认**不超过标准**为通过，除第一项外）
- 详细信息（满足当前条件的所有信息）



预期：一次遍历，返回信息中有所有的统计信息，实现：

- 使用标记位标识不同的检查信息
- 检查哪些项目，将这些项标记加起来作为参数

```lua
local StdRatio = 0x00000001
local Ratio = 0x00000010
local Pass = 0x00000100
local Detail = 0x00001000
... ...

analyze(data, checkitem, ranges, Ratio + Pass + Detail)
```



```lua
-- input
-- 1. 检查对象/详细信息中的key
checkitem = 'D'
-- 2. 配置数组
-- 【生成过程进行提取和优化】
ranges = {
    {min = 0, max = 4, standard = 0},
    {min = 5, max = 5, standard = 1},
    {min = 6, max = 6, standard = 1},
    ... ...
},
-- 3. 详细信息
pfxsdata = {
    {id = 1, name = '1', D = 1},
    {id = 2, name = '2', D = 2},
    {id = 3, name = '3', D = 5},
    ... ...
}
-- 4. 选择返回的内容
local expectinfo = StdRatio + Ratio + Pass + details

-- output
{
    -- min, max = 0, 4
    {
        stdratio = 0,
        ratio = 0.5,
        pass = true, 
        details = {
            {id = 1, name = '1', D = 1},
            {id = 2, name = '2', D = 2},
            ...
        }
    },
    -- min, max = 5, 5
    {
        stdratio = 1,
        ratio = 0.2,
        pass = true, 
        details = {
            {id = 3, name = '3', D = 5},
            ...
        }
    }
    ... ...
}
```



### 对于每一条分类（主角、怪物…）的检查

对于WP的需求，输入是所有信息

- 分析总览情况（总组）
- 根据字符串筛选出组（分组），再进行分析

对于每个组（以下为每个组的配置信息）

- 检查D、P等信息
- 返回同样结构的详细信息

```lua
-- rule info
{
    filter = 'cha\\',
    showname = '主角',
    -- D ranges
    D = {
        {min = 0, max = 4, standard = 0},
        {min = 5, max = 5, standard = 1},
    },
    -- P ranges
    P = {
        {min = 0, max = 4, standard = 0},
        {min = 5, max = 5, standard = 1},
    }
}
-- 检查项，当且仅当checkitems中有且rule中有时，才会检查对应项
local checkitems = {'D', 'P'}
-- 返回的内容
local expectinfo = StdRatio + Ratio + Pass + details

-- output
{
    D = {
        -- min, max = 0, 4
        {
            stdratio = 0,
            ratio = 0.5,
            pass = true, 
            details = {
                {id = 1, name = '1', D = 1},
                {id = 2, name = '2', D = 2},
                ...
            }
        },
        -- min, max = 5, 5
        {
            stdratio = 1,
            ratio = 0.2,
            pass = true, 
            details = {
                {id = 3, name = '3', D = 5},
                ...
            }
        }
        ... ...
    }
    P = {
        -- min, max = 0, 4
        {
            stdratio = 0,
            ratio = 0.5,
            pass = true, 
            details = {
                {id = 1, name = '1', P = 1},
                {id = 2, name = '2', P = 2},
                ...
            }
        },
        -- min, max = 5, 5
        {
            stdratio = 1,
            ratio = 0.2,
            pass = true, 
            details = {
                {id = 3, name = '3', P = 5},
                ...
            }
        }
        ... ...
    }
}
```



**一定提供的数据**

总：showname

- 标准比例
- 实际比例

**可选择的数据**

- 是否通过
- 详细信息
- ……



# 1221

TODO：

- 检查特效子进程tf换个位置
- 删除中间数据处理（从功能模块、commands例子、job全部删除）
- 完善表格生成



问题：

1. lua max
2. 同类命名放一起
3. dataCollector命名









充电话费

