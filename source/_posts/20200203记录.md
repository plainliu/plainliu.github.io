---
title: 20200120记录
date: 2020-02-04 15:19:37
tags:
---



# 0203

请假

# 0204

xxx

被删除

# 0205

pipeline整理

尝试在Jenkinsfile所在的目录下写groovy文件，找资料/测试能否访问定义的函数

https://www.w3cschool.cn/jenkins/jenkins-wliy28oy.html

应该是可以的，除了使用github全球共享库的方式，本地/文件夹 方式也可以进行共享的



需要注意能否并行，指定并行多少个

哪些可以并行



不用写地址，用pipeline方式拿资源是拿到了相对路径下，即安装Jenkins的盘

引来的问题是，大的资源几个检查工具，盘不够用，不好分盘



1. pipeline github库出现连接不上的问题

   准备用Jenkinsfile同级目录加文件的方式（应该这样可以，再看看详细资料），暂时解决文件冗长的问题

2. 所用检查功能整理到一个pipeline之后，多次调用的并行触发问题

   比如检查特效，期望kog-prod的多次检查特效是排队的，但是不希望kog检查特效和狂暴检查特效排队。

   有同时进行的需求，也有排队进行的需求（已知的是整个pipeline有是否允许并发的控制，内部可不可以通过参数控制还不知道）

3. checkout 到安装Jenkins的盘不够用的问题

   pipeline自带的checkout功能，co的地址是相对于pipeline workspace的**相对地址**，测试过一次绝对地址不可以。如果资源拿到了安装Jenkins的盘，可能有盘不够用，不好分盘，或者多任务公用一个磁盘互相影响速度的问题。



# 0206

## 自动化测试

http://10.1.1.13/fancy/fancy-sample/WT/15719-lua内存分配统计  

Heroman 2-6 10:21:06
昨天自动跑的还没有差异

Heroman 2-6 10:21:31
今天我用任意的相统引擎单独跑，log打印都是有差异

Heroman 2-6 10:21:37
相同  



需要修改自动化检查工具

## 整理job

继续填充内容

今天先把检查动画的跑起来



后面加错误上报的，需要加个py发送错误



项目资源的svn拿资源，需要用公共账户？Jenkins上的两个账户可能拿不了



记录过程：

pipeline公共空间中不能使用params的值，访问值为null





已验证，co用绝对路径失败：

log见 http://10.1.1.190:8080/job/pipeline-ljjcheckres-test/20/console



如果只用相对路径

那么一台机器上各检查工具所用的svn资源，都在 Jenkins/workspace目录下的pipeline job对应的文件夹中。

假定集合的pipeline job为 job-pipeline-wpcheckres

该pipeline**允许并发构建**，那么每次执行， job-pipeline-wpcheckres文件夹或tmp文件夹中，有一个module和一个res目录

res目录是用来拿项目资源，不同项目之间不能switch，所以需要用项目名称区分res，如命名为res_kog

如果**不允许并发构建**，同上，在一个目录中，可能出现多个res，设置和上面一样，module可以不区分名称，res需要用项目名称区分



接口：

```groovy
string(name: 'GAMENAME', defaultValue: 'KOG', description: '项目名'),
string(name: 'CHECKFUNC', defaultValue: 'checksan', description: '检查功能'),
string(name: 'CHECKMODE', defaultValue: 'dev', description: '检查的模式，dev/test/prod')
```

那这样的话还是可以打包和检查只提供一个接口，分发给打包任务或检查任务；

找匹配也就可以直接写在这个总Jenkinsfile中了，转换参数的任务就在这个job中；

打包任务和检查任务只需要关注自己真正的参数就可以，比如模块svn、资源svn等；

打包任务不需要

## 云主机奇怪现象

先用镜像部署一台机器，设置的密码是12位的那个老密码，初始化后没启动；
第一次重启，只有一个进程；
第二次重启，正常启动了



猜测：

1. 被提镜像的时候，当时部署好的机器的开机密码不是12位的长密码



## TODO

- [ ] 验证云主机奇怪现象
- [ ] 每日自动测试的优化和处理
- [ ] 云主机机器人一键部署



# 0207

问题和待办

1. 把参数变成选项

   比如：项目名称、提供的功能等

2. 检查特效，需要保留，不能clean地co

   需要把缓存另存到其他位置，防止clean覆盖

3. 并发执行任务的问题

   并发会导致多次co资源，期望一台机器上或者某一类任务不能并发执行，各机器和各类任务间可并发执行

4. 上报错误的实现

   正常过程中的posturl和错误上报的地址是不是一个

5. 



记录

Jenkinsfile访问函数的方法：

1. 用共享库

   github上的git库中添加以函数名命名的文件`def call(){}`

2. 在Jenkinsfile中定义

   `pipeline{}`外定义函数`def myFunc(){}`

3. Jenkinsfile的统计目录下以固定组织方式扩展文件



远程主机问题：

1. 初始化后，启动失败，错误码2147943726

   错误：` 0x8007052e (2147943726) "unknown user name or bad password"`

2. 手动启动计划任务运行，正常

3. 重启，正常

猜测：

从现象看，猜测是：提取的镜像中，任务设置的密码和登录密码不一致。

猜测的原因：

在初始化部署后的一次执行，第一次拉不起来。（再之前，用Kog12345部署老镜像，第一次可以拉起来）。初始化部署的这次拉起操作还没发生登录，镜像中保存的登录密码有效。

网页上部署新机器的密码，在后续操作中有效机器远程或重启后