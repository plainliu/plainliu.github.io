---
title: 20190520记录
date: 2019-08-16 13:21:54
tags: 记录
---

# cct-code

## 使用tmp-table

```lua
local tmpv3_1 = _Vector3.new()
local tmpv3_2 = _Vector3.new()
```

使用tmp-table，减少内存消耗

在编辑器代码中也有同样的地方，在gloable.lua中

## 问题

1. node.cct:onControllerHit
2. 



# 自己写小工具

- 批处理文件
- 脚本



# 伪随机

随机种子

随机种子确定，如果初值相同，随机的次数相同，那么随机值也是相同的。

# 自动测试新需求

检查所有资源文件，自动跑一趟，截图，对比

- 自己的思路过于僵化，原来的自动测试过程如何，便想着又应该如何如何，但实际将原来的工作重复做了一遍；和柳哥交流完，发现自己原来走在一条黑胡同，没有向别的地方看。
- 柳哥提供的思路，直接在当前的自动测试基础上做，大方向来看是做两个dofile的文件，顿时清晰许多，我的想法“没必要”那么做。

## 当前做法

Idle调用playNext

playNext中做渲染、截图、统计帧数、切换资源

> WT：
>
> 资源检查方式
>
> 1. 对于动画资源，检查同时存在skl和skn资源，才会加载，如果二者存在缺失，那么会忽略该资源，不会加载动画资源

## 记

检查资源，生成oplua操作文件

（先dofile check，在check中生成oplua，然后dofile oplua）

时间控制，如何检测当前特效播放结束，和oplua操作同步，卡帧数？

check.lua放在哪里？

原来是WT，Sample中遍历找lua

添加项目的路径，在当前自动测试目录中找check.lua

最后生成的图片在fobA,fobB中新增resource的文件夹

这样也可以在自动测试目录中文件夹Resource下放项目



条件`tickcount <= 3`截图结果不是严格3帧，每3帧之后一张空图，4帧一个周期



改check文件，用**鼠标事件控制playNext**切换运行资源，所以在oplua中仍然用鼠标事件控制截图，记录文件名称，用来生产同名文件夹放对应截图



**Q：**

1. `self:doStep() func()`

```lua
	self:captureScreen()
	if self.currentstep > #self.steps then
		self:endReplay()
		return
	end

	if self.steps[1].ops then
		self:doStepOld()
	else
		self:doStepNew()
	end

	self.currentstep = self.currentstep + 1
```

先截图，再doStepOld doStepNew（设置是否截图），之后currentstep加1，最后执行func()

为什么截图是从1开始？

2. tick = 3，而4帧一周期的原因

   skl

3. 做法：

   - 先dofile（check.lua中做？）生成oplua文件
   - 在自动测试文件中dofile check.lua之后dofile oplua
   - 截图设置名称 or 每个资源对应一个文件夹

file return 资源数目计算出的对应帧数，返回赋值给自动测试计步



# FS-WT

- http://fancy3d.wt.fancyguo.com/task/show/14796  #14796 【KOG】【场景】阻挡墙应一直附着逻辑地表，现在逻辑是显示逻辑地表的时候才贴逻辑地表

- http://fancy3d.wt.fancyguo.com/task/show/14790 #14790 【KOG】【场景】选择多个模型可以显示面数

    ```lua
    meshui.sides.text = node.mesh:getFaceCount()
    meshui.point.text = node.mesh:getVertexCount()
    ```

- http://fancy3d.wt.fancyguo.com/task/show/14791 #14791 【KOG】【场景】列表中支持上下键切换选中对象

    KeyDown摄像机的事件和list的事件是否冲突

    `setCurrentPfx(pfx)`

    `ui.focusTo(variableUI.pfxListUI[pfx.index])`
    
    `updateSelectParticle()`

    ![1558680480342](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1558680480342.png)

    问题：场景编辑器中上下键没有触发listnode的事件，当前只能触发摄像机的位置变化

    > node:click()自动触发了onFocus()

    **原因**：
    
   1. 重写了node的函数，所以focused == false
      
    ```lua
    function node:onFocus()
        addUndoOperationSEN{changeSEN = false}
    end
    ```
   
    2. click之后setCurrent设置focus到node
   

   
    
   
    **备忘**：
   
    
   
    1. viewer.lua中的KeyDown；上下键时Camera不要动
   
    2. 检查其他list（subMeshList），删掉重写的onFocus
       
       - meshlist：重写了onFocus，按name等没focus到node上
       
       - subMeshList：两层listnode，focus的是top，不是node
       
       - scenelist：onFocus是OK的，但是上下键没触发；重写了onKey
           > click之后focus在list上，不在node上
           >
           > 在新场景时加setCurrent
           >
           > 原因：重写了onKey来做delete，特效当中重写的key
           >
           > Q：key|onKey，click|onClick()
       
       - resourceList：list1，list2
       
           > list1没加，list2加了focusTo（现象与pointList同）
       
       - skybox.image.imagelist：位置？
       
       - pointList = ui.right.wallpro.bottom.wall.list
       
           ```lua
           function node:click()
           	hideIndicator{}
           	setCurDummyOwner{owner = variable.chooseWalls[1], index = 2 * point.index - 1}
           	-- setCurrentPoint{} -- debug框内刷数字，引擎崩溃
           	-- ui.focusTo(node) -- 不加上下键会跨行（看打印：上下键没有改变调用onFocus，onUnFocus），加了后表现是对的
           end
           ```
       
       - orbitCameraList = ui.right.orbitpro.bottom.orbitlist.bottom.list 位置？
       
       - groupListUI = ui.right.grouppro.bottom.bottom.list 怎么分组
       
       - ui.sceneedit.bottom.total.terrainAccordin.node 地形的list咋出来
       
       - ……sceneAccordin.node
       
       - ……skyboxAccordin……
       
       - ……shadowAccordin……
       
       - ……edgeAccordin……
       
       - ……scrBlendAccordin……
       
       - ……hdrAccordin……
       
       - ……postAccordin……
       
       - ……vignetteAccordin……
       
       - ……orbitAccordin……
       
       - ……meshAccordin.bottom.meshlist.node
       
       - ……areaAccordin.bottom.arealist.node
       
       - ……markerlist
       
       - ……waterlist
       
       - ……lightlist
       
       - ……foglist
       
       - ……walllist
       
       - ……cameralist
       
       - ……pfxlist
       
       - pMaterialAccordin.bottom.materiallist.node
       
       - groupAccordin.grouplist
       
       - ui.new.open
       
       - ui.new.historyproject
       
       - ui.new.Abouteditor.midd.listmid
       
       - ui.new.lost
       
       - errorimageslist
       
       - ui.new.material.materiallist
       
       - materialui.bottom.lerp
       
       - ......layers
       
       - ui.new.helpeditor.mouselist
       
       - ……keyboardlist
       
       - ui.new.versionlist
       
       - ui.new.dupname.namelist
       
       - ui.new.lerpnamelist













![1558694749284](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1558694749284.png)

subMeshList遇到的问题（点击第一个node，按上建）



在其他node:click中加focusTo

找问题：1. 查ui是否一样；2. 查onFocus和onKey是否触发

多个场景一个摄像机，同时变动





已处理：

左侧所有

场景下拉列表和各左侧场景资源编辑列表

右侧：资源列表的文件列表，墙的顶点，模型的材质列表

在ui选中状态时，摄像机不能通过WASD和上下键移动



> listnode之后修改成mapone的方法



- http://fancy3d.wt.fancyguo.com/task/show/14793 #14793 【KOG】【场景】选择模型提示不够明显

