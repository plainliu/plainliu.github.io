---
title: 20190909记录
date: 2019-10-08 10:43:00
tags:
- 记录
---

# 1014

查资源检查工具检查过程

job部署，添加默认co路径

# 1015

子job从文件读取配置（分享到218）



## 资源检查工具

### Alpha通道为0xFF的图片的检查和处理

**一、验证ios平台打包图片格式转换**

1. 准备三种图片资源
   - RGBA（alpha通道有效）
   - RGBA（alpha通道无用）
   - RGB
2. PVR工具转换图片
3. 写例子
4. xcode测试ios打包的结果

**结果**

序号 | 图片 | 原图大小K |  压缩后大小K 
-|-|-|-
1|RGBA（alpha通道有效） | 4097 | 683 
2|RGBA（alpha通道无用） | 4097 | 683 
3|RGB | 3073 | 683 

1. 压缩后加载正常

2. 二进制：1 != 2 == 3

三张图片在Xcode上看gpu调用，均为rgba格式

**二、将2和3的图片压缩为rgb**

1. 查pvr转换脚本，查看pvr转换工具的参数

   ```
   Encode Format:
   Usage
           -f [format],<variabletype>,<colourspace>
   Example
           -f PVRTC1_2,UBN,lRGB
   
   -Valid Formats: PVRTC1_2, PVRTC1_4, PVRTC1_2_RGB, PVRTC1_4_RGB, PVRTC2_2, PVRTC2_4, ETC1, BC1, BC2, BC3,UYVY, YUY2, 1BPP, RGBE9995, RGBG8888, GRGB8888, ETC2_RGB, ETC2_RGBA, ETC2_RGB_A1, EAC_R11, EAC_RG11, ASTC_4x4, ASTC_5x4, ASTC_5x5, ASTC_6x5, ASTC_6x6, ASTC_8x5, ASTC_8x6, ASTC_8x8, ASTC_10x5, ASTC_10x6, ASTC_10x8, ASTC_10x10, ASTC_12x10, ASTC_12x12, ASTC_3x3x3, ASTC_4x3x3, ASTC_4x4x3, ASTC_4x4x4, ASTC_5x4x4, ASTC_5x5x4, ASTC_5x5x5, ASTC_6x5x5, ASTC_6x6x5, ASTC_6x6x6
   
   -Valid Variable Types: UB, UBN, SB, SBN, US, USN, SS, SSN, UI, UIN, SI, SIN, UF, SF.
   ```

   

2. 修改

   - 原来的：
     Texture_Factory\res\PVRTexTool.exe -f PVRTC1_4  -m -i "res\rgba.bmp" -o "res\rgba.pvr"
   - 对于_mf:isAlphaImage()为false的修改 PVRTC1_4为PVRTC1_4_RGB：
     PVRTexTool.exe -f PVRTC1_4_RGB  -m -i "res\rgb.bmp" -o "res\rgb.pvr"

   修改之后看gpu调用，是rgb的

3. 验证实际使用的内存是否减少

   链接https://gameinstitute.qq.com/community/detail/100055

   没有减少，rgb和rgba的内存占用相同

4. 区分rgb和rgba的图片，使用不同的pvr转换命令，保持和Android处理是格式一致

   修改打包工具中转换图片代码

   - 老工具

     - 单线程
     - 多线程

   - 新工具

     - module中的模块修改

     写单元测试（发现用老打包工具和模块打包工具打包结果不一样，和柳哥确认）

5. 测试

   新老工具：

   - ios打包单线程
   - 多线程

**三、分析没有转换的图片情况（写工具）**

1. 图片

   - RGBA（alpha通道有效）
   - **RGBA（alpha通道无用）**
   - RGB

2. 检查32位，非alpha的图片情况

   文件名、数量占比、文件大小占比

3. 工具

   - 输入：路径；规则：文件夹或者扩展名
   - 输出：
     - alpha通道无效图/总图（数量比、大小比）
     - alpha通道无效图/总图（大小比）
     - 不合格list

4. 实现

   先筛选isAlphaImage为false的

   之后再排除24位的

   **问题**

   - 原来的筛选是按照name做筛选，不带路径（**带路径的串没有被匹配到**）

   - 筛选的列表中需要写成模式串，如果字符串中有`-`，则需要写成`%-`，例如`"kog_nhg_01-height.bmp"`需要写成`"kog_nhg_01%-height%.bmp"`（**部分有特殊字符的图片没有被匹配到**）

     ![1571287364559](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1571287364559.png)

5. 验证忽略路径的问题

   引擎的打包工具没有忽略

   kog项目的包解开是忽略的，问王子这里项目修复了问题

   备注：需要修改引擎的打包工具并**提交**

6. 修复工具报告问题

   - 问题：需要只报告bpp32的Alpha无效的图片

   - 方案：加接口获得bpp并出报告，看是否为32位的运行内存

   - 结果：发现所有的非特殊图片在引擎中均处理成了32位，柳哥讲”opengl上24位不如32，以前就是想省内存 后来发现影响性能“

     https://developer.arm.com/docs/dui0555/b/optimization-checklist/the-checklist/do-not-use-24-bit-textures

7. 调整报告方案

   和龙哥讨论，先出一版报告，看Alpha无效的图片占的内存大小，BPP单位Byte

   `BPP * image.width * image.height / 1024 (KB)`

   其中忽略list中的图

    项 | Android | ios 
    -|-|-
    图总数count | 40114 | 40114 
    不转换格式count | 3648 | 3643 
    Alpha通道无效count | 114 | 114 
    大小size | 37,484.02KB | 37,484.02KB 
    内存memory | 143,248.72KB | 143,248.72KB 

8. 其他记录

   - 拷贝资源所占的时间20多分钟
   - 检查Android的mesh和场景忽略的时间8分钟左右

**四、转换alpha通道无效的图片**

先搁置，总共的可优化内存比较小

先处理优先级高的优化内容

# 1017

上面的Alpha通道资源检查

出现一些不稳定例子，屏蔽不稳定例子

# 1018

- [ ] 整理检测Alpha通道无效的代码
- [x] #15187 【F3D】【黑片】mix2模型上有黑片

- [x] 把资源检查的结果保存下来，以便进行后续分析和检查

- [ ] 218上记录文件读取配置

- [ ] 记录如何测试shader问题

- [x] 留排除不稳定例子印记
- [ ] 自动更新并关闭自动更新
- [ ] 添加子模块的单元测试

## WT15187 【F3D】【黑片】mix2模型上有黑片

### 复现问题

- co bcp资源
- 连接服务器

### 理解问题

查看菲涅尔效果

**菲涅尔**

- 应用

  一般运用于水面效果，试想一下你站在湖边，低头看向水里，你会发现近的地方非常清澈见底（反射较少），而看远的地方却倒映着天空（反射较多）。这就是菲尼尔效应

- 由于真实的菲尼尔公式计算量较多。在游戏里往往会用简化版的公式来提升效率达到近似的效果

```
fresnel = fresnel基础值 + fresnel缩放量*pow( 1 - dot( N, V ), 5 )
```

CPU准备数据发送给GPU进行渲染，DallCall

shader

**Cg（C for Graphic）/ HLSL（High Level Shading Language）/ GLSL（OnpenGL Shading Language）**

GLSL

> 用来在OpenGL中着色编程的语言，也即开发人员写的短小的自定义程序，他们是在图形卡的GPU （Graphic Processor Unit图形处理单元）上执行的，代替了固定的渲染管线的一部分，使渲染管线中不同层次具有可编程性。比如：视图转换、投影转换等。GLSL（GL Shading Language）的着色器代码分成2个部分：Vertex Shader（顶点着色器）和Fragment（片断着色器），有时还会有Geometry Shader（几何着色器）。负责运行顶点着色的是顶点着色器。它可以得到当前OpenGL 中的状态，GLSL内置变量进行传递。GLSL其使用C语言作为基础高阶着色语言，避免了使用汇编语言或硬件规格语言的复杂性。

两种查看shader的方式

- 工具直接查看
- VS联调查看

GLSL 三种变量类型（uniform，attribute和varying）理解



验证bloom开启关闭的黑片效果

两种分析结果和处理方法

- z=0时是否需要开启菲涅尔效果，不进行x^0运算
- 保证0^0 = 1

### z=0时是否开启菲涅尔效果

判断使用哪种处理方法

### 修改

没有修改shader，改了引擎

- OpenGL
- Metal

### 测试

- PC（验证同样的阶段不走菲涅尔计算）
- Android
- iOS

# 1019

修复和验证黑片问题

## Jenkins子job的参数传递

子job的参数传递：

![1571489760488](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1571489760488.png)

有以上参数参数可选

我们已经用到的有**Predefined parameters**和**NodeLabel parameter**两种，

- **NodeLabel parameter**

  执行job的node标签

- **Predefined parameters**

  已定义参数，This project is parameterized定义的参数。

  局限：后续job的入参的值要么固定，要么由环境变量和入参进行简单的组合获取，无法融入逻辑语句。

- **Parameters from properties file**

  若后续job的入参的值需要一定逻辑处理才能获取，那么，这种传参方式就特别好用了，比较灵活。

## Nsight使用





待办：

看保险配置

说话不要带。。。。。这个

备注：

胡：

做外围也有做外围的好处，更快地掌握总体的架构和系统

anaconda